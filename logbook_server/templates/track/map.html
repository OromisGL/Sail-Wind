{% extends 'base.html' %}


{% block title %}
    Map
{% endblock %}


{% block content %}
{% block extra_style %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

    <script>
        let mapInstance, windMarker;
    
        // 1) Laufmap initialisieren
        function initMap(lat, lon) {
        mapInstance = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);
        windMarker = L.marker([lat, lon]).addTo(mapInstance);
        }
    
        // 2) Globale Funktion fÃ¼r Button-Klicks
        window.loadWindData = function(locationName) {
        console.log("loadWindData called with:", locationName);
    
        fetch(`/track/api/wind_by_location?location=${encodeURIComponent(locationName)}`)
            .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok (${response.status})`);
            }
            return response.json();
            })
            .then(data => {
            // Karte animiert verlagern
            mapInstance.flyTo([data.lat, data.lon], 13, {
                animate: true,
                duration: 3
            });
    
            // Marker versetzen
            windMarker.setLatLng([data.lat, data.lon]);
    
            // Wind-Overlay updaten
            document.getElementById('wind-speed')
                    .textContent    = `Velocity: ${data.wind_speed} m/s`;
            document.getElementById('wind-strength')
                    .textContent    = `Wind Strength: ${data.beaufort}`;
            document.getElementById('wind-direction')
                    .textContent    = `Direction: ${data.compass_direction}`;
    
            const arrow = document.getElementById('wind-arrow');
            arrow.src    = `data:image/png;base64,${data.wind_arrow}`;
            arrow.style.transform = `rotate(${data.wind_direction}deg)`;
    
            document.getElementById('wind-info').style.display = 'block';
            })
            .catch(err => console.error("Error loading wind data:", err));
        };
    
        // 3) Buttons mit data-lake hooken und Map initialisieren
        document.addEventListener("DOMContentLoaded", () => {
        // Default-Koordinaten aus Flask (werden via render_template eingesetzt)
        const defaultLat = {{ LATITUDE }};
        const defaultLon = {{ LONGITUDE }};
        initMap(defaultLat, defaultLon);
    
        // Alle Sidebar-Buttons, die data-lake tragen, an click binden
        document.querySelectorAll(".lake-button").forEach(btn => {
            btn.addEventListener("click", () => {
            const lakeName = btn.dataset.lake;
            loadWindData(lakeName);
            });
        });
    
        // Optional: direkt den ersten See laden
        {% if initial_location_name %}
        loadWindData({{ initial_location_name|tojson }});
        {% endif %}
        });
    </script>

    <div id="map">

        <div id="wind-info">
            <p><b>Wind Data</b></p>
            <p id="wind-speed">Velocity: {{ wind_speed }} m/s</p>
            <p id="wind-strength">Wind Strength: {{ getBeauforScale }}</p>
            <p id="wind-direction">Direction: {{ compass_direction }}</p>

            <img id="wind-arrow" src="data:image/png;base64,{{ wind_arrow }}" style="transform: rotate({{ wind_direction }}deg);">
            <img id="DWD-Logo" src="data:image/png;base64,{{ DWD_logo }}">
        </div>
    </div>

{% endblock %}